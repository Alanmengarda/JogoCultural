const bandeiras = [
  {
    pais: "Brasil üáßüá∑",
    pecas: [
      { id: 1, tipo: "superior", cor: "#009739", texto: "Verde" },
      { id: 2, tipo: "meio", cor: "#FEDD00", texto: "Amarelo" },
      { id: 3, tipo: "inferior", cor: "#012169", texto: "Azul" }
    ],
    explicacao: "A bandeira do Brasil tem fundo verde (florestas), losango amarelo (riquezas minerais) e c√≠rculo azul com estrelas (c√©u).",
    ordem_correta: [1, 2, 3]
  },
  {
    pais: "Alemanha üá©üá™",
    pecas: [
      { id: 1, tipo: "superior", cor: "#000000", texto: "Preto" },
      { id: 2, tipo: "meio", cor: "#DD0000", texto: "Vermelho" },
      { id: 3, tipo: "inferior", cor: "#FFCE00", texto: "Amarelo" }
    ],
    explicacao: "A bandeira alem√£ tem tr√™s faixas horizontais: preto (determina√ß√£o), vermelho (coragem) e amarelo (generosidade).",
    ordem_correta: [1, 2, 3]
  },
  {
    pais: "Fran√ßa üá´üá∑",
    pecas: [
      { id: 1, tipo: "esquerda", cor: "#0055A4", texto: "Azul" },
      { id: 2, tipo: "meio", cor: "#FFFFFF", texto: "Branco" },
      { id: 3, tipo: "direita", cor: "#EF4135", texto: "Vermelho" }
    ],
    explicacao: "A bandeira francesa (tricolor) tem tr√™s faixas verticais: azul (liberdade), branco (igualdade) e vermelho (fraternidade).",
    ordem_correta: [1, 2, 3]
  },
  {
    pais: "It√°lia üáÆüáπ",
    pecas: [
      { id: 1, tipo: "esquerda", cor: "#009246", texto: "Verde" },
      { id: 2, tipo: "meio", cor: "#FFFFFF", texto: "Branco" },
      { id: 3, tipo: "direita", cor: "#CE2B37", texto: "Vermelho" }
    ],
    explicacao: "A bandeira italiana tem tr√™s faixas verticais: verde (esperan√ßa), branco (f√©) e vermelho (caridade).",
    ordem_correta: [1, 2, 3]
  },
  {
    pais: "Jap√£o üáØüáµ",
    pecas: [
      { id: 1, tipo: "fundo", cor: "#FFFFFF", texto: "Branco" },
      { id: 2, tipo: "centro", cor: "#BC002D", texto: "Sol Vermelho" }
    ],
    explicacao: "A bandeira japonesa (Hinomaru) tem fundo branco (pureza) com um c√≠rculo vermelho (sol nascente).",
    ordem_correta: [1, 2]
  }
];

let indiceAtual = 0;
let acertos = 0;
let tentativas = 0;
let pecasColocadas = [];

function carregarBandeira() {
  const bandeira = bandeiras[indiceAtual];
  document.getElementById("titulo-jogo").innerHTML = `üß© Monte a bandeira de ${bandeira.pais}`;

  // Limpar √°reas
  document.getElementById("pecas-disponiveis").innerHTML = "";
  document.getElementById("area-montagem").innerHTML = "";
  document.getElementById("resultado-mini").innerHTML = "";
  document.getElementById("resultado-mini").className = "";
  pecasColocadas = [];

  // Criar pe√ßas embaralhadas
  const pecasEmbaralhadas = [...bandeira.pecas].sort(() => Math.random() - 0.5);
  
  pecasEmbaralhadas.forEach((peca, index) => {
    const elementoPeca = criarPeca(peca, false);
    elementoPeca.style.animationDelay = `${index * 0.1}s`;
    document.getElementById("pecas-disponiveis").appendChild(elementoPeca);
  });

  // Criar slots de montagem
  bandeira.pecas.forEach((peca, index) => {
    const slot = criarSlot(peca, index);
    document.getElementById("area-montagem").appendChild(slot);
  });
}

function criarPeca(peca, naArea = false) {
  const div = document.createElement('div');
  div.className = `peca ${naArea ? 'na-area' : 'disponivel'}`;
  div.draggable = !naArea;
  div.dataset.id = peca.id;
  div.dataset.tipo = peca.tipo;
  
  // Criar visual da pe√ßa baseado no tipo
  let visualPeca = '';
  if (peca.tipo === 'superior' || peca.tipo === 'meio' || peca.tipo === 'inferior') {
    // Faixas horizontais
    visualPeca = `
      <div class="peca-visual horizontal" style="background: ${peca.cor};">
        <span class="peca-texto">${peca.texto}</span>
      </div>
    `;
  } else if (peca.tipo === 'esquerda' || peca.tipo === 'direita') {
    // Faixas verticais
    visualPeca = `
      <div class="peca-visual vertical" style="background: ${peca.cor};">
        <span class="peca-texto">${peca.texto}</span>
      </div>
    `;
  } else if (peca.tipo === 'fundo') {
    // Fundo completo
    visualPeca = `
      <div class="peca-visual fundo" style="background: ${peca.cor}; border: 2px solid #ccc;">
        <span class="peca-texto">${peca.texto}</span>
      </div>
    `;
  } else if (peca.tipo === 'centro') {
    // Elemento central (como sol do Jap√£o)
    visualPeca = `
      <div class="peca-visual centro" style="background: ${peca.cor};">
        <span class="peca-texto">${peca.texto}</span>
      </div>
    `;
  }
  
  div.innerHTML = visualPeca;
  
  if (!naArea) {
    div.addEventListener('dragstart', drag);
    div.addEventListener('dragend', dragEnd);
  }
  
  return div;
}

function criarSlot(peca, index) {
  const div = document.createElement('div');
  div.className = `slot slot-${peca.tipo}`;
  div.dataset.aceita = peca.id;
  div.dataset.posicao = index;
  
  // Criar placeholder visual
  let placeholder = '';
  if (peca.tipo === 'superior' || peca.tipo === 'meio' || peca.tipo === 'inferior') {
    placeholder = `<div class="placeholder horizontal">Arraste ${peca.texto} aqui</div>`;
  } else if (peca.tipo === 'esquerda' || peca.tipo === 'direita') {
    placeholder = `<div class="placeholder vertical">Arraste ${peca.texto} aqui</div>`;
  } else if (peca.tipo === 'fundo') {
    placeholder = `<div class="placeholder fundo">Arraste ${peca.texto} aqui</div>`;
  } else if (peca.tipo === 'centro') {
    placeholder = `<div class="placeholder centro">Arraste ${peca.texto} aqui</div>`;
  }
  
  div.innerHTML = placeholder;
  
  div.addEventListener('dragover', allowDrop);
  div.addEventListener('drop', drop);
  
  return div;
}

function drag(ev) {
  ev.dataTransfer.setData("text", ev.target.dataset.id);
  ev.target.style.opacity = '0.5';
  ev.target.style.transform = 'rotate(5deg) scale(1.1)';
  ev.target.classList.add('arrastando');
}

function dragEnd(ev) {
  ev.target.style.opacity = '1';
  ev.target.style.transform = 'rotate(0deg) scale(1)';
  ev.target.classList.remove('arrastando');
}

function allowDrop(ev) {
  ev.preventDefault();
  ev.target.closest('.slot').classList.add('slot-hover');
}

function drop(ev) {
  ev.preventDefault();
  const slot = ev.target.closest('.slot');
  slot.classList.remove('slot-hover');
  
  const pecaId = parseInt(ev.dataTransfer.getData("text"));
  const slotAceita = parseInt(slot.dataset.aceita);
  const posicao = parseInt(slot.dataset.posicao);
  
  if (pecaId === slotAceita) {
    // Pe√ßa correta
    const pecaOriginal = document.querySelector(`[data-id="${pecaId}"].disponivel`);
    if (pecaOriginal) {
      const bandeira = bandeiras[indiceAtual];
      const pecaData = bandeira.pecas.find(p => p.id === pecaId);
      
      // Remover pe√ßa da √°rea de pe√ßas dispon√≠veis
      pecaOriginal.remove();
      
      // Adicionar pe√ßa ao slot
      const novaPeca = criarPeca(pecaData, true);
      slot.innerHTML = '';
      slot.appendChild(novaPeca);
      
      // Registrar pe√ßa colocada
      pecasColocadas[posicao] = pecaId;
      
      // Efeito visual de sucesso
      slot.classList.add('slot-preenchido');
      novaPeca.style.animation = 'pecaEncaixe 0.5s ease-out';
      
      // Verificar se completou
      if (pecasColocadas.filter(p => p !== undefined).length === bandeira.pecas.length) {
        setTimeout(verificarCompleto, 500);
      }
    }
  } else {
    // Pe√ßa incorreta - efeito de erro
    slot.classList.add('slot-erro');
    setTimeout(() => {
      slot.classList.remove('slot-erro');
    }, 600);
    
    // Vibra√ß√£o de erro
    if (navigator.vibrate) {
      navigator.vibrate([100, 50, 100]);
    }
  }
}

function verificarCompleto() {
  const bandeira = bandeiras[indiceAtual];
  const resultadoDiv = document.getElementById("resultado-mini");
  
  tentativas++;
  
  // Verificar se a ordem est√° correta
  const ordemCorreta = pecasColocadas.every((pecaId, index) => 
    pecaId === bandeira.ordem_correta[index]
  );
  
  if (ordemCorreta) {
    acertos++;
    resultadoDiv.innerHTML = `‚úÖ <strong>Perfeito!</strong><br>${bandeira.explicacao}`;
    resultadoDiv.className = "correto";
    
    // Efeito de sucesso
    criarEfeitoSucesso();
    
    // Vibra√ß√£o de sucesso
    if (navigator.vibrate) {
      navigator.vibrate([100, 50, 100, 50, 100]);
    }
  }
  
  // Atualizar estat√≠sticas
  atualizarEstatisticas();
}

function criarEfeitoSucesso() {
  // Criar efeito de confete
  for (let i = 0; i < 20; i++) {
    const confete = document.createElement('div');
    confete.style.cssText = `
      position: fixed;
      width: 8px;
      height: 8px;
      background: ${['#00ffff', '#ff00ff', '#ffff00', '#00ff88'][Math.floor(Math.random() * 4)]};
      border-radius: 50%;
      pointer-events: none;
      z-index: 9999;
      left: 50%;
      top: 30%;
      animation: confetti${i} 2s ease-out forwards;
    `;
    
    // Criar anima√ß√£o √∫nica para cada confete
    const style = document.createElement('style');
    style.textContent = `
      @keyframes confetti${i} {
        0% {
          transform: translate(0, 0) rotate(0deg) scale(1);
          opacity: 1;
        }
        100% {
          transform: translate(${(Math.random() - 0.5) * 300}px, ${Math.random() * 300 + 100}px) rotate(${Math.random() * 360}deg) scale(0);
          opacity: 0;
        }
      }
    `;
    document.head.appendChild(style);
    document.body.appendChild(confete);
    
    // Remover elementos ap√≥s anima√ß√£o
    setTimeout(() => {
      confete.remove();
      style.remove();
    }, 2000);
  }
}

function reiniciar() {
  carregarBandeira();
}

function proximaBandeira() {
  indiceAtual = (indiceAtual + 1) % bandeiras.length;
  
  // Efeito de transi√ß√£o
  const container = document.querySelector('.container');
  container.style.transform = 'scale(0.95)';
  container.style.opacity = '0.7';
  
  setTimeout(() => {
    carregarBandeira();
    container.style.transform = 'scale(1)';
    container.style.opacity = '1';
  }, 200);
}

function atualizarEstatisticas() {
  // Criar ou atualizar painel de estat√≠sticas
  let stats = document.getElementById('stats-panel');
  if (!stats) {
    stats = document.createElement('div');
    stats.id = 'stats-panel';
    stats.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(20, 20, 40, 0.9);
      border: 2px solid var(--primary-color);
      border-radius: 15px;
      padding: 15px;
      color: var(--text-light);
      font-weight: bold;
      backdrop-filter: blur(10px);
      z-index: 1000;
      min-width: 150px;
    `;
    document.body.appendChild(stats);
  }
  
  const porcentagem = tentativas > 0 ? Math.round((acertos / tentativas) * 100) : 0;
  stats.innerHTML = `
    <div style="text-align: center; color: var(--primary-color); margin-bottom: 10px;">üìä STATS</div>
    <div>‚úÖ Acertos: ${acertos}</div>
    <div>üéØ Tentativas: ${tentativas}</div>
    <div>üìà Taxa: ${porcentagem}%</div>
  `;
}

// Adicionar anima√ß√µes CSS extras
function adicionarAnimacoesExtras() {
  const style = document.createElement('style');
  style.textContent = `
    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes pecaEncaixe {
      0% {
        transform: scale(0.8) rotate(-10deg);
      }
      50% {
        transform: scale(1.1) rotate(5deg);
      }
      100% {
        transform: scale(1) rotate(0deg);
      }
    }
    
    @keyframes pulseGlow {
      0%, 100% {
        box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
      }
      50% {
        box-shadow: 0 0 40px rgba(0, 255, 255, 0.6);
      }
    }
  `;
  document.head.appendChild(style);
}

// Inicializa√ß√£o
window.onload = function() {
  adicionarAnimacoesExtras();
  carregarBandeira();
  atualizarEstatisticas();
};